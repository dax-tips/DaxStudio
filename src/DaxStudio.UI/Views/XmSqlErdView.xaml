<ctrl:ZoomableUserControl x:Class="DaxStudio.UI.Views.XmSqlErdView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:cal="http://caliburnmicro.com"
             xmlns:ctrl="clr-namespace:DaxStudio.UI.Controls"
             xmlns:conv="clr-namespace:DaxStudio.UI.Converters"
             xmlns:vm="clr-namespace:DaxStudio.UI.ViewModels"
             mc:Ignorable="d" 
             d:DesignHeight="450" d:DesignWidth="800"
             Background="{DynamicResource Theme.Brush.Content.Back}">
    
    <UserControl.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="pack://application:,,,/DaxStudio.UI;Component/Resources/DaxStudioResources.xaml" />
                <ResourceDictionary Source="pack://application:,,,/DaxStudio.UI;Component/Resources/Styles/BusyPanel.xaml" />
            </ResourceDictionary.MergedDictionaries>

            <conv:BoolToHiddenConverter x:Key="BoolToVisibilityConverter" />
            <conv:BoolToCollapsedConverter x:Key="BoolToCollapsedConverter" />
            <conv:HeatLevelToColorConverter x:Key="HeatLevelToColorConverter" />
            
            <!-- Column Item Style -->
            <Style x:Key="ColumnItemStyle" TargetType="Border">
                <Setter Property="BorderBrush" Value="{DynamicResource Theme.Brush.Table.Border}"/>
                <Setter Property="BorderThickness" Value="0,0,0,1"/>
                <Setter Property="Padding" Value="6,2"/>
            </Style>

            <!-- Table Card Template with Heat Map, Selection, and Drag support -->
            <DataTemplate x:Key="TableCardTemplate" DataType="{x:Type vm:ErdTableViewModel}">
                <Border x:Name="TableBorder"
                        BorderThickness="1"
                        BorderBrush="#CCCCCC"
                        CornerRadius="4"
                        Width="{Binding Width}"
                        MinHeight="80"
                        Background="{DynamicResource Theme.Brush.Content.Back}"
                        Cursor="Hand"
                        MouseLeftButtonDown="Table_MouseLeftButtonDown"
                        MouseLeftButtonUp="Table_MouseLeftButtonUp"
                        MouseMove="Table_MouseMove">
                    <Border.Effect>
                        <DropShadowEffect x:Name="Shadow" BlurRadius="8" ShadowDepth="2" Opacity="0.3" Direction="315"/>
                    </Border.Effect>
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>
                        
                        <!-- Table Header with Heat Map Color -->
                        <Border Grid.Row="0" 
                                CornerRadius="4,4,0,0"
                                Padding="8,4"
                                Background="{Binding HeatColor}">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                
                                <!-- Table Icon -->
                                <TextBlock Grid.Column="0" 
                                           Text="ðŸ“Š" 
                                           FontSize="12" 
                                           Margin="0,0,6,0"
                                           VerticalAlignment="Center"/>
                                
                                <!-- Table Name -->
                                <TextBlock Grid.Column="1"
                                           Text="{Binding TableName}"
                                           FontWeight="SemiBold"
                                           Foreground="White"
                                           TextTrimming="CharacterEllipsis"
                                           VerticalAlignment="Center"
                                           ToolTip="{Binding TableName}"/>
                                
                                <!-- Hit Count Badge -->
                                <Border Grid.Column="2"
                                        Background="White"
                                        CornerRadius="8"
                                        Padding="6,1"
                                        Margin="4,0,0,0"
                                        Opacity="0.9"
                                        VerticalAlignment="Center">
                                    <TextBlock Text="{Binding HitCount}"
                                               FontSize="10"
                                               FontWeight="SemiBold"
                                               Foreground="#333"/>
                                </Border>
                            </Grid>
                        </Border>
                        
                        <!-- Columns List -->
                        <ScrollViewer Grid.Row="1" 
                                      VerticalScrollBarVisibility="Auto"
                                      MaxHeight="120">
                            <ItemsControl ItemsSource="{Binding Columns}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate DataType="{x:Type vm:ErdColumnViewModel}">
                                        <Border Style="{StaticResource ColumnItemStyle}">
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="20"/>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                </Grid.ColumnDefinitions>
                                                
                                                <!-- Usage Icons using Path geometry (renders reliably) -->
                                                <StackPanel Grid.Column="0" 
                                                            Orientation="Horizontal" 
                                                            VerticalAlignment="Center"
                                                            ToolTip="{Binding UsageTooltip}">
                                                    <!-- Key icon for Join (golden key shape) -->
                                                    <Path Data="M6,0 L6,4 L8,4 L8,6 L6,6 L6,8 L4,8 L4,6 L0,6 L0,4 L4,4 L4,0 Z M5,1 A2,2 0 1,0 5,3 A2,2 0 1,0 5,1"
                                                          Fill="#DAA520" Width="10" Height="10" Stretch="Uniform" Margin="0,0,2,0"
                                                          Visibility="{Binding IsJoinColumn, Converter={StaticResource BoolToCollapsedConverter}}"/>
                                                    <!-- Funnel/Filter icon (purple) -->
                                                    <Path Data="M0,0 L10,0 L6,5 L6,9 L4,10 L4,5 Z"
                                                          Fill="#9932CC" Width="10" Height="10" Stretch="Uniform" Margin="0,0,2,0"
                                                          Visibility="{Binding IsFilterColumn, Converter={StaticResource BoolToCollapsedConverter}}"/>
                                                    <!-- Sum/Sigma icon (blue) -->
                                                    <Path Data="M0,0 L8,0 L8,2 L3,2 L6,5 L3,8 L8,8 L8,10 L0,10 L0,8 L4,5 L0,2 Z"
                                                          Fill="#1E90FF" Width="10" Height="10" Stretch="Uniform" Margin="0,0,2,0"
                                                          Visibility="{Binding IsAggregateColumn, Converter={StaticResource BoolToCollapsedConverter}}"/>
                                                    <!-- Checkmark icon (green) -->
                                                    <Path Data="M0,5 L3,8 L9,2 L10,3 L3,10 L-1,6 Z"
                                                          Fill="#32CD32" Width="10" Height="10" Stretch="Uniform" Margin="0,0,2,0"
                                                          Visibility="{Binding IsSelectColumn, Converter={StaticResource BoolToCollapsedConverter}}"/>
                                                </StackPanel>
                                                
                                                <!-- Column Name -->
                                                <TextBlock Grid.Column="1"
                                                           Text="{Binding ColumnName}"
                                                           FontSize="11"
                                                           Foreground="{DynamicResource Theme.Brush.Default.Fore}"
                                                           TextTrimming="CharacterEllipsis"
                                                           VerticalAlignment="Center"
                                                           ToolTip="{Binding ColumnName}">
                                                    <TextBlock.Style>
                                                        <Style TargetType="TextBlock">
                                                            <Style.Triggers>
                                                                <DataTrigger Binding="{Binding IsJoinColumn}" Value="True">
                                                                    <Setter Property="FontWeight" Value="SemiBold"/>
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </TextBlock.Style>
                                                </TextBlock>
                                                
                                                <!-- Aggregation Badge -->
                                                <TextBlock Grid.Column="2"
                                                           Text="{Binding AggregationText}"
                                                           FontSize="9"
                                                           Foreground="{DynamicResource Theme.Brush.Log.Warning}"
                                                           Visibility="{Binding IsAggregateColumn, Converter={StaticResource BoolToCollapsedConverter}}"
                                                           VerticalAlignment="Center"
                                                           Margin="4,0,0,0"/>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </ScrollViewer>
                    </Grid>
                </Border>
                
                <!-- Visual states for selection/highlighting -->
                <DataTemplate.Triggers>
                    <!-- Selected state -->
                    <DataTrigger Binding="{Binding IsSelected}" Value="True">
                        <Setter TargetName="TableBorder" Property="BorderBrush" Value="#FF0078D4"/>
                        <Setter TargetName="TableBorder" Property="BorderThickness" Value="3"/>
                    </DataTrigger>
                    
                    <!-- Dimmed state -->
                    <DataTrigger Binding="{Binding IsDimmed}" Value="True">
                        <Setter TargetName="TableBorder" Property="Opacity" Value="0.4"/>
                    </DataTrigger>
                </DataTemplate.Triggers>
            </DataTemplate>
            
        </ResourceDictionary>
    </UserControl.Resources>
    
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        
        <!-- Toolbar -->
        <ctrl:ClipBorder Grid.Row="0"
                         CornerRadius="4"
                         Background="{DynamicResource Theme.Brush.MenuBar.Back}"
                         Margin="0,0,0,8">
            <DockPanel LastChildFill="False">
                <TextBlock DockPanel.Dock="Left"
                           Text="Query Dependencies Diagram"
                           FontWeight="SemiBold"
                           FontSize="14"
                           Foreground="{DynamicResource Theme.Brush.Default.Fore}"
                           VerticalAlignment="Center"
                           Margin="10,8"/>
                
                <Button DockPanel.Dock="Right"
                        Content="Clear Selection"
                        Margin="4,8,8,8"
                        Padding="12,4"
                        cal:Message.Attach="[Event Click] = [Action ClearSelection]"/>
                
                <Button DockPanel.Dock="Right"
                        Content="Copy to Clipboard"
                        Margin="4,8"
                        Padding="12,4"
                        cal:Message.Attach="[Event Click] = [Action CopyToClipboard]"/>
            </DockPanel>
        </ctrl:ClipBorder>
        
        <!-- Main Canvas Area -->
        <ScrollViewer x:Name="MainScrollViewer"
                      Grid.Row="1"
                      HorizontalScrollBarVisibility="Auto"
                      VerticalScrollBarVisibility="Auto"
                      Background="{DynamicResource Theme.Brush.Content.Back}">
            <Grid MinWidth="{Binding ActualWidth, ElementName=MainScrollViewer}"
                  MinHeight="{Binding ActualHeight, ElementName=MainScrollViewer}"
                  Width="{Binding CanvasWidth}" 
                  Height="{Binding CanvasHeight}"
                  MouseLeftButtonDown="Canvas_MouseLeftButtonDown"
                  Background="{DynamicResource Theme.Brush.Content.Back}">
                
                <!-- Relationship Lines Layer (behind tables) -->
                <ItemsControl ItemsSource="{Binding Relationships}">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <Canvas Background="Transparent"/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemContainerStyle>
                        <Style TargetType="ContentPresenter">
                            <!-- Position at 0,0 - the Path uses absolute coordinates -->
                            <Setter Property="Canvas.Left" Value="0"/>
                            <Setter Property="Canvas.Top" Value="0"/>
                        </Style>
                    </ItemsControl.ItemContainerStyle>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate DataType="{x:Type vm:ErdRelationshipViewModel}">
                            <!-- Use a Grid instead of Canvas so Path can use absolute coords -->
                            <Grid>
                                <!-- Relationship Line -->
                                <Path StrokeThickness="2"
                                      StrokeDashArray="4 2"
                                      Data="{Binding PathData}">
                                    <Path.Style>
                                        <Style TargetType="Path">
                                            <Setter Property="Stroke" Value="{DynamicResource Theme.Brush.Accent}"/>
                                            <Setter Property="Opacity" Value="1"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding IsHighlighted}" Value="True">
                                                    <Setter Property="Stroke" Value="#FF0078D4"/>
                                                    <Setter Property="StrokeThickness" Value="3"/>
                                                </DataTrigger>
                                                <DataTrigger Binding="{Binding IsDimmed}" Value="True">
                                                    <Setter Property="Opacity" Value="0.3"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Path.Style>
                                    <Path.ToolTip>
                                        <StackPanel>
                                            <TextBlock FontWeight="SemiBold">
                                                <Run Text="{Binding FromTable, Mode=OneWay}"/>.<Run Text="{Binding FromColumn, Mode=OneWay}"/>
                                            </TextBlock>
                                            <TextBlock Text="{Binding JoinTypeText}" Foreground="Gray"/>
                                            <TextBlock FontWeight="SemiBold">
                                                <Run Text="{Binding ToTable, Mode=OneWay}"/>.<Run Text="{Binding ToColumn, Mode=OneWay}"/>
                                            </TextBlock>
                                            <TextBlock>
                                                <Run Text="Hit Count: "/><Run Text="{Binding HitCount, Mode=OneWay}"/>
                                            </TextBlock>
                                        </StackPanel>
                                    </Path.ToolTip>
                                </Path>
                            </Grid>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
                
                <!-- Relationship Labels Layer (separate so they appear on top) -->
                <ItemsControl ItemsSource="{Binding Relationships}">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <Canvas/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemContainerStyle>
                        <Style TargetType="ContentPresenter">
                            <Setter Property="Canvas.Left" Value="{Binding LabelX}"/>
                            <Setter Property="Canvas.Top" Value="{Binding LabelY}"/>
                        </Style>
                    </ItemsControl.ItemContainerStyle>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate DataType="{x:Type vm:ErdRelationshipViewModel}">
                            <Border Background="{DynamicResource Theme.Brush.MenuBar.Back}"
                                    CornerRadius="3"
                                    Padding="4,1">
                                <TextBlock Text="{Binding JoinTypeText}"
                                           FontSize="9"
                                           Foreground="{DynamicResource Theme.Brush.Default.Fore}"/>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
                
                <!-- Tables Layer -->
                <ItemsControl ItemsSource="{Binding Tables}">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <Canvas/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemContainerStyle>
                        <Style TargetType="ContentPresenter">
                            <Setter Property="Canvas.Left" Value="{Binding X}"/>
                            <Setter Property="Canvas.Top" Value="{Binding Y}"/>
                        </Style>
                    </ItemsControl.ItemContainerStyle>
                    <ItemsControl.ItemTemplate>
                        <StaticResource ResourceKey="TableCardTemplate"/>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
                
            </Grid>
        </ScrollViewer>
        
        <!-- Status Bar -->
        <ctrl:ClipBorder Grid.Row="2"
                         CornerRadius="4"
                         Background="{DynamicResource Theme.Brush.StatusBar.Back}"
                         Margin="0,8,0,0"
                         Padding="10,6">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                
                <TextBlock Grid.Column="0"
                           Text="{Binding SummaryText}"
                           Foreground="{DynamicResource Theme.Brush.StatusBar.Fore}"
                           VerticalAlignment="Center"/>
                
                <StackPanel Grid.Column="1" Orientation="Horizontal">
                    <TextBlock Text="Legend: " 
                               Foreground="{DynamicResource Theme.Brush.StatusBar.Fore}"
                               VerticalAlignment="Center"
                               Margin="0,0,8,0"/>
                    <TextBlock Text="ðŸ”‘ Join Key" 
                               Foreground="{DynamicResource Theme.Brush.StatusBar.Fore}"
                               VerticalAlignment="Center"
                               Margin="0,0,12,0"/>
                    <TextBlock Text="ðŸ” Filter" 
                               Foreground="{DynamicResource Theme.Brush.StatusBar.Fore}"
                               VerticalAlignment="Center"
                               Margin="0,0,12,0"/>
                    <TextBlock Text="ðŸ“Š Aggregate" 
                               Foreground="{DynamicResource Theme.Brush.StatusBar.Fore}"
                               VerticalAlignment="Center"
                               Margin="0,0,12,0"/>
                    <TextBlock Text="âœ“ Select" 
                               Foreground="{DynamicResource Theme.Brush.StatusBar.Fore}"
                               VerticalAlignment="Center"
                               Margin="0,0,12,0"/>
                    <TextBlock Text="ðŸ”¥ Heat = Usage" 
                               Foreground="{DynamicResource Theme.Brush.StatusBar.Fore}"
                               VerticalAlignment="Center"/>
                </StackPanel>
            </Grid>
        </ctrl:ClipBorder>
        
        <!-- Loading Overlay -->
        <Grid Grid.RowSpan="3"
              Visibility="{Binding IsLoading, Converter={StaticResource BoolToCollapsedConverter}}"
              Background="#80000000">
            <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                <TextBlock Text="Analyzing SE Events..."
                           Foreground="White"
                           FontSize="16"
                           HorizontalAlignment="Center"/>
            </StackPanel>
        </Grid>
        
        <!-- No Data Message -->
        <TextBlock Grid.Row="1"
                   Text="No SE query data to analyze. Run a query with Server Timings enabled, then click 'Show Dependencies' to see the diagram."
                   Visibility="{Binding NoData, Converter={StaticResource BoolToVisibilityConverter}}"
                   Foreground="{DynamicResource Theme.Brush.Default.Fore}"
                   HorizontalAlignment="Center"
                   VerticalAlignment="Center"
                   TextWrapping="Wrap"
                   Margin="40"/>
    </Grid>
</ctrl:ZoomableUserControl>
